* cfDNA Copy Numer Alteration Analysis :biopipe:
:PROPERTIES:
:logging: nil
:header-args:bash: :tangle-mode (identity #o555)
:END:
** Setup
*** [[file:config/int_test.yaml][Snakemake configuration YAML]]
#+begin_src bash :tangle ./config/int_test.yaml
container:
  cfdna_wgs: "~/sing_containers/cfdna_wgs.1.0.0.sif"
  default: "~/sing_containers/biotools.1.0.2.sif"

dir:
  cfdna_wgs_repo: "./"
  cfdna_wgs_scripts: "workflow/scripts"
  data: "test"

threads:
    default: "4"

#+end_src
*** Integration testing setup
#+begin_src bash
singularity shell --bind /mnt ~/sing_containers/cfdna_wgs.1.0.0.sif

# Clear bam directory if present
if [ -r test/bam ]; then \rm -rf test/bam; fi
mkdir -p test/bam

# Create small bam files to store in repo. Subsample real bams to ~100 Mb.
sambamba view -s .005 -f bam -t 36 /mnt/ris/aadel/mpnst/bam/lib070_dedup_sorted.bam > test/bam/lib001_hg19.bam
sambamba view -s .005 -f bam -t 36 /mnt/ris/aadel/mpnst/bam/lib054_dedup_sorted.bam > test/bam/lib002_hg19.bam
sambamba view -s .005 -f bam -t 36 /mnt/ris/aadel/mpnst/test/bam/new_HiSeq15_L002001_ACAC_extract_ds20.bam > test/bam/lib003_hg38.bam
sambamba view -s .005 -f bam -t 36 /mnt/ris/aadel/mpnst/test/bam/new_HiSeq15_L002001_ATCG_extract_ds20.bam > test/bam/lib004_hg38.bam

sambamba view -s 0.01 -f bam -t 4 /mnt/ris/aadel/mpnst/bam/cfdna_wgs/ds/lib105_ds10.bam > test/bam/lib005.bam
sambamba view -s 0.01 -f bam -t 4 /mnt/ris/aadel/mpnst/bam/cfdna_wgs/ds/lib205_ds10.bam > test/bam/lib006.bam



for file in test/bam/*.bam; do samtools index $file; done

#+end_src
** [[file:workflow/cfdna_wgs_cna.smk][cfDNA WGS CNA]] :smk:
:PROPERTIES:
:header-args:snakemake: :tangle ./workflow/cfdna_wgs_cna.smk
:END:
*** DONE Fragment size filtering
- snakemake
  #+begin_src snakemake
rule frag_filt:
    input:
        cfdna_wgs_cna_bam_inputs + "/{library}.bam",
    params:
        script = cfdna_wgs_scripts + "/frag_filt.sh",
    output:
        nohead =   temp(cfdna_wgs_cna_bam_fragfilt + "/{library}_frag{frag_distro}.nohead"),
        onlyhead = temp(cfdna_wgs_cna_bam_fragfilt + "/{library}_frag{frag_distro}.onlyhead"),
        final =         cfdna_wgs_cna_bam_fragfilt + "/{library}_frag{frag_distro}.bam",
    container:
        cfdna_wgs_container
    shell:
        """
        frag_min=$(echo {wildcards.frag_distro} | sed -e "s/_.*$//g")
        frag_max=$(echo {wildcards.frag_distro} | sed -e "s/^.*_//g")
        {params.script} \
        {input} \
        {output.nohead} \
        $frag_min \
        $frag_max \
        {config[threads]} \
        {output.onlyhead} \
        {output.final}
        """
#+end_src
- shell
  #+begin_src bash :tangle ./workflow/scripts/frag_filt.sh

# Steps
## Filter by absolute value of TLEN for each read
sambamba view -t $5 $1 | awk -F'\t' -v upper="$4" 'sqrt($9*$9) < upper {print $0}' | awk -F'\t' -v lower="$3" 'sqrt($9*$9) > lower {print $0}'> $2

## Restore header
sambamba view -H $1 > $6

cat $6 $2 | sambamba view -t 4 -S -f bam /dev/stdin | sambamba sort -t 4 -o $7 /dev/stdin

#+end_src
*** DONE Convert bam to wig
#+begin_src snakemake
rule bam_to_wig:
    input:
        cfdna_wgs_cna_bam_fragfilt + "/{library}_frag{frag_distro}.bam",
    output:
        wig + "/{library}_frag{frag_distro}.wig",
    params:
        chrs = "chr1,chr2,chr3,chr4,chr5,chr6,chr7,chr8,chr9,chr10,chr11,chr12,chr13,chr14,chr15,chr16,chr17,chr18,chr19,chr20,chr21,chr22,chrX,chrY"
    container:
        cfdna_wgs_container,
    shell:
        """
        /opt/hmmcopy_utils/bin/readCounter --window 1000000 --quality 20 \
        --chromosome {params.chrs} \
        {input} > {output}
        """
#+end_src

*** DONE Make list of wigs from normals                               :smk_rule:
- Snakemake
  #+begin_src snakemake
# Make ichorCNA panel of normals from healthy samples
rule pon_list:
    input:
        expand(wig + "/{library}_frag{frag_distro}.wig", library = NORMAL_LIBRARIES, frag_distro = ["90_150"]),
    output:
        wig + "/normal.txt",
    log:
        cfdna_wgs_logs + "/pon.log",
    container:
        cfdna_wgs_container,
    shell:
        """
        input_string=$(echo "{input}" | tr " " "\n")
        if [ -f {output} ]; then rm {output}; fi
        echo -e "${{input_string}}" >> {output}
        """
#+end_src
*** DONE Make panel of normals                                        :smk_rule:
- Snakemake
  #+begin_src snakemake
# Make ichorCNA panel of normals from healthy samples
rule pon:
    input:
        wig + "/normal.txt",
    params:
        script = cfdna_wgs_scripts + "/pon.sh",
	outdir = wig
    output:
        wig + "/pon_median.rds"
    log:
        cfdna_wgs_logs + "/pon.log",
    container:
        cfdna_wgs_container,
    shell:
        """
        {params.script} \
        {input} \
        {params.outdir} &> {log}
        """
#+end_src
- [[file:./workflow/scripts/pon.sh][Shell script]]
  #+begin_src bash :tangle ./workflow/scripts/pon.sh
#!/usr/bin/env bash
filelist=$1
out_dir=$2

Rscript /opt/ichorCNA/scripts/createPanelOfNormals.R --filelist $filelist \
        --chrs "paste0('chr', c(1:22, \"X\"))" \
        --chrNormalize "c(1:22, \"X\")" \
        --gcWig /opt/ichorCNA/inst/extdata/gc_hg38_1000kb.wig \
        --mapWig /opt/ichorCNA/inst/extdata/map_hg38_1000kb.wig \
        --centromere /opt/ichorCNA/inst/extdata/GRCh38.GCA_000001405.2_centromere_acen.txt  \
        --outfile "${out_dir}/pon"

#+end_src

*** DONE Run ichor
#+begin_src snakemake
rule ichor:
    input:
        wig = wig + "/{library}_frag{frag_distro}.wig",
	pon = wig + "/pon_median.rds",
    output:
        ichor + "/{library}_frag{frag_distro}.cna.seg",
    params:
        script = cfdna_wgs_scripts + "/MOD_runIchorCNA.R",
        out_dir = ichor,
    container:
        cfdna_wgs_container,
    shell:
        """
        Rscript {params.script} \
         --id {wildcards.library}_frag{wildcards.frag_distro} \
         --WIG {input.wig} \
         --gcWig /opt/ichorCNA/inst/extdata/gc_hg38_1000kb.wig \
         --mapWig /opt/ichorCNA/inst/extdata/map_hg38_1000kb.wig \
         --centromere /opt/ichorCNA/inst/extdata/GRCh38.GCA_000001405.2_centromere_acen.txt \
         --normal "c(0.95, 0.99, 0.995, 0.999)" \
         --normalPanel {input.pon} \
         --ploidy "c(2)" \
         --maxCN 3 \
         --estimateScPrevalence FALSE \
         --scStates "c()" \
         --outDir {params.out_dir}
        """
#+end_src
- Testing
  - hg38 test
    #+begin_src bash
  # mkdir /tmp/ichor_out
  # singularity shell ~/sing_containers/mpnst.sif

  Rscript /opt/ichorCNA/scripts/runIchorCNA.R --id tumor_sample \
  --WIG /tmp/test.wig --ploidy "c(2,3)" --normal "c(0.5,0.6,0.7,0.8,0.9)" --maxCN 5 \
  --gcWig /opt/ichorCNA/inst/extdata/gc_hg38_1000kb.wig \



  --includeHOMD False --chrs "c(1:22, \"X\")" --chrTrain "c(1:22)" \
  --estimateNormal True --estimatePloidy True --estimateScPrevalence True \
  --scStates "c(1,3)" --txnE 0.9999 --txnStrength 10000 --outDir /tmp/ichor_out
  #+end_src
  - works
    - hg19
      #+begin_src bash
  #mkdir -p /tmp/ichor_out
  #singularity shell ~/sing_containers/mpnst.sif

  # Notes
  ##
  ## Will overwrite target files with a warning
  ##
  ##


  Rscript /opt/ichorCNA/scripts/runIchorCNA.R --id tumor_sample \
    --WIG ~/repos/cfdna-cna/test/wig/lib002_hg19_frag90_150.wig --ploidy "c(2,3)" --normal "c(0.5,0.6,0.7,0.8,0.9)" --maxCN 5 \
    --gcWig /opt/ichorCNA/inst/extdata/gc_hg19_1000kb.wig \
    --mapWig /opt/ichorCNA/inst/extdata/map_hg19_1000kb.wig \
    --centromere /opt/ichorCNA/inst/extdata/GRCh37.p13_centromere_UCSC-gapTable.txt \
    --normalPanel /opt/ichorCNA/inst/extdata/HD_ULP_PoN_1Mb_median_normAutosome_mapScoreFiltered_median.rds \
    --includeHOMD False --chrs "c(1:22, \"X\")" --chrTrain "c(1:22)" \
    --estimateNormal True --estimatePloidy True --estimateScPrevalence True \
    --scStates "c(1,3)" --txnE 0.9999 --txnStrength 10000 --outDir /tmp/ichor_out
  #+end_src
      #+begin_src bash
  # mkdir /tmp/ichor_out
  # singularity shell ~/sing_containers/mpnst.sif

  Rscript ./workflow/scripts/MOD_runIchorCNA.R --id tumor_sample \
    --WIG ~/repos/cfdna-cna/test/wig/lib002_frag90_150.wig --ploidy "c(2,3)" --normal "c(0.5,0.6,0.7,0.8,0.9)" --maxCN 5 \
    --gcWig /opt/ichorCNA/inst/extdata/gc_hg19_1000kb.wig \
    --mapWig /opt/ichorCNA/inst/extdata/map_hg19_1000kb.wig \
    --centromere /opt/ichorCNA/inst/extdata/GRCh37.p13_centromere_UCSC-gapTable.txt \
    --normalPanel /opt/ichorCNA/inst/extdata/HD_ULP_PoN_1Mb_median_normAutosome_mapScoreFiltered_median.rds \
    --includeHOMD False --chrs "c(1:22, \"X\")" --chrTrain "c(1:22)" \
    --estimateNormal True --estimatePloidy True --estimateScPrevalence True \
    --scStates "c(1,3)" --txnE 0.9999 --txnStrength 10000 --outDir /tmp/ichor_out
  #+end_src
      - running an old hg19
        #+begin_src bash
      Rscript /opt/ichorCNA/scripts/runIchorCNA.R --id tumor_sample \
        --WIG /tmp/test_hg19.wig --ploidy "c(2,3)" --normal "c(0.5,0.6,0.7,0.8,0.9)" --maxCN 5 \
        --gcWig /opt/ichorCNA/inst/extdata/gc_hg19_1000kb.wig \
        --mapWig /opt/ichorCNA/inst/extdata/map_hg19_1000kb.wig \
        --centromere /opt/ichorCNA/inst/extdata/GRCh37.p13_centromere_UCSC-gapTable.txt \
        --normalPanel /opt/ichorCNA/inst/extdata/HD_ULP_PoN_1Mb_median_normAutosome_mapScoreFiltered_median.rds \
        --includeHOMD False --chrs "c(1:22, \"X\")" --chrTrain "c(1:22)" \
        --estimateNormal True --estimatePloidy True --estimateScPrevalence True \
        --scStates "c(1,3)" --txnE 0.9999 --txnStrength 10000 --outDir /tmp/ichor_out_test
      #+end_src
  - d
    #+begin_src bash
  Rscript workflow/scripts/MOD_runIchorCNA.R --id lib003_hg38_frag90_150 \
          --WIG test/wig/lib003_hg38_frag90_150.wig \
          --gcWig /opt/ichorCNA/inst/extdata/gc_hg38_1000kb.wig \
          --mapWig /opt/ichorCNA/inst/extdata/map_hg38_1000kb.wig \
          --centromere /opt/ichorCNA/inst/extdata/GRCh38.GCA_000001405.2_centromere_acen.txt \
          --normal "c(0.95, 0.99, 0.995, 0.999)" \
          --ploidy "c(2)" \
          --maxCN 3 \
          --estimateScPrevalence FALSE \
          --scStates "c()" \
          --outDir test/ichor_hg38



          # --normalPanel /opt/ichorCNA/inst/extdata/HD_ULP_PoN_hg38_1Mb_median_normAutosome_median.rds \
  #                                                   HD_ULP_PoN_hg38_1Mb_median_normAutosome_median.rds
  #+end_src
- Notes: Fails when extdata PoN specified
*** :dev:
:PROPERTIES:
:header-args:snakemake: :tangle no
:END:
- testing
  #+begin_src bash
#singularity shell --bind /mnt:/mnt ~/sing_containers/mpnst.sif


/opt/hmmcopy_utils/bin/readCounter \
 --window 1000000 \
 --quality 20 \
 --chromosome "chr1,chr2,chr3,chr4,chr5,chr6,chr7,chr8,chr9,chr10,chr11,chr12,chr13,chr14,chr15,chr16,chr17,chr18,chr19,chr20,chr21,chr22,chrX" \
 ~/repos/cfdna-cna/test/bam/lib004_hg38.bam > /tmp/test.wig

#+end_src
**** Run hg19 ichor
#+begin_src snakemake
rule hg19_ichor:
    input:
        config["wig_dir"] + "/{library_id}_frag{frag_distro}.wig",
    output:
        config["ichor_hg19_dir"] + "/{library_id}_frag{frag_distro}.cna.seg",
    shell:
        """
        Rscript {config[cfdna_cna_repo]}/workflow/scripts/MOD_runIchorCNA.R \
         --id {wildcards.library_id}_frag{wildcards.frag_distro} \
         --WIG {input} \
         --gcWig /opt/ichorCNA/inst/extdata/gc_hg19_1000kb.wig \
         --normal "c(0.95, 0.99, 0.995, 0.999)" \
         --ploidy "c(2)" \
         --maxCN 3 \
         --estimateScPrevalence FALSE \
         --scStates "c()" \
         --outDir {config[ichor_hg19_dir]}
        """
#+end_src
** INPROCESS Integration testing                                        :smk:
:PROPERTIES:
:header-args:snakemake: :tangle ./workflow/int_test.smk
:END:
*** Preamble, path declarations, functions, etc.
#+begin_src snakemake :tangle ./workflow/int_test.smk
#container: config["container"]

LIBRARIES = ["lib003",
	     "lib004",
	     "lib005",
	     "lib006"]

NORMAL_LIBRARIES = ["lib003", "lib004"]

cfdna_wgs_container = config["container"]["cfdna_wgs"]
cfdna_wgs_scripts = config["dir"]["cfdna_wgs_repo"] + "/workflow/scripts"

cfdna_wgs_cna_bam_inputs   = config["dir"]["data"] + "/bam/filt"
cfdna_wgs_cna_bam_fragfilt = config["dir"]["data"] + "/bam/frag"

wig = config["dir"]["data"] + "/wig"
ichor = config["dir"]["data"] + "/ichor"
cfdna_wgs_logs = config["dir"]["data"] + "logs/cfdna_wgs"

#+end_src
*** All rule
#+begin_src snakemake :tangle ./workflow/int_test.smk
rule all:
    input:
	# Fragment-filtered bam
        #expand(cfdna_wgs_cna_bam_fragfilt + "/{library}_frag{frag_distro}.bam", library = LIBRARIES, frag_distro = ["90_150"]),
	# Wiggle
        #expand(wig + "/{library}_frag{frag_distro}.wig", library = LIBRARIES, frag_distro = ["90_150"]),
        # PoN list
        #wig + "/normal.txt",
        # PoN
        #wig + "/pon_median.rds",
	# Ichor
        expand(ichor + "/{library}_frag{frag_distro}.cna.seg", library = LIBRARIES, frag_distro = ["90_150"]),
#+end_src
*** Includes
#+begin_src snakemake
include: "cfdna_wgs_cna.smk"
#+end_src
** README
*** Change Log
- [2022-04-29 Fri]: First commit, copying from the old mpnst-cna repo. Untested.
** Ideas
- Ideas- biocparallel? for ichor sections
- https://mail.google.com/mail/u/0/#inbox/FMfcgzGmtrMStSdxMHbXDpqGDVTrjMpl
- ichor PON
- extract tf
  tfRAW = as_tibble(read.table(file.path(repo,"data/tf_summary"), header = F, sep = '\t'))

target_cnaRAW = as_tibble(read.table(file.path(repo,"data/target_cna.bed"), sep = '\t', header = F))

taylor_washoutRAW = as_tibble(read.csv(file.path(repo, "data/cfDNA PN and MPNST washout libraries for ROC.csv"), header = T))

coverageRAW = as_tibble(read.table(file.path(repo,"data/all_dedup_coverage.tsv"), sep='\t', header = T))

librariesRAW = as_tibble(
  read.csv(file.path(repo,"data/library_index.csv"), header = T)
)

washout_libs = as_tibble(
read.csv(file.path(repo,"data/washout_libs.csv"), header = T)
)

specimensRAW = as_tibble(
  read.csv(file.path(repo,"data/specimen_index.csv"), header = T)
  )

subjectsRAW = as_tibble(
  read.csv(file.path(repo, "data/subject_index.csv"), header = T)
  )

  #+begin_src R
library(tidyverse)

load("/mnt/ris/aadel/mpnst/data_model/data_model.RData")

ls()

names(libraries_full)

class(libraries_full$collect_date)

libraries_full$collect_date = as.Date(libraries_full$collect_date)

as.numeric(libraries_full$collect_date[[1]]- libraries_full$collect_date[[2]])

test =
  libraries_full %>% arrange(collect_date) %>% group_by(participant_id, isolation_type) %>%
  mutate(collect_day = as.numeric(collect_date - first(collect_date))) %>%
  mutate(collect_day = replace_na(collect_day, 0))

tf = read.table("/tmp/tf.tsv", header = F, sep = '\t')
colnames(tf) = c("libnfrag", "tf", "ploidy")
tf$library_id = substr(tf$libnfrag, 1, 6)

tf2 =
  tf %>% filter(grepl("sub20m_frag90", libnfrag))


test2=tf2 %>% left_join(test, by = "library_id")

write.csv(file ="/tmp/test.csv", test2)
test %>% select(participant_id, collect_day) %>% arrange(participant_id) %>% print(n = Inf)



test$collect_day

  case_when(collect_date == first(collect_date) ~ 0,
                                 collect_date > first(collect_date) ~ collect_date - first(collect_date)))




) %>% select(library_id, participant_id, collect_day)
#+end_src
*** Dev
:PROPERTIES:
:header-args:snakemake: :tangle no
:END:
**** Aggregate ichor
**** CN LOH
https://github.com/mskcc/facets
https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5027494/
- a CN LOH call is NOT available in ichor, is in titanCNA
- FACETS is used for CN-LOH in cfDNA- https://aacrjournals.org/clincancerres/article/28/3/526/678032/Activation-of-PI3K-AKT-Pathway-Is-a-Potential

  https://sites.google.com/site/mskfacets/
;https://www.ncbi.nlm.nih.gov/pmc/articles/PMC6267593/

facets for independent ichor confirm? https://github.com/mskcc/facets/issues/72
ichor does cn loh calls- check out
